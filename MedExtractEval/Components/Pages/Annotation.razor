@page "/annotation"
@using System.ComponentModel.DataAnnotations
@inject IAnnotationAppService AnnotationService
@using System.Security.Claims
@using MedExtractEval.DTOs
@using MedExtractEval.Services
@using Microsoft.AspNetCore.Authorization
@inject AuthenticationStateProvider AuthStateProvider
@rendermode InteractiveServer
@attribute [Authorize]
@implements IAsyncDisposable

<h3 class="mb-3">Annotation</h3>
<AuthorizeView Context="auth">
    <Authorized>
        @if (Case is null)
        {
            <div class="alert alert-secondary">Loading…</div>
        }
        else
        {
            <div class="container-fluid px-0">
                <div class="row g-3">

                    <!-- Left: Raw report text -->
                    <div class="col-12 col-lg-8">
                        <div class="card shadow-sm">
                            <div class="card-header d-flex align-items-center justify-content-between">
                                <div class="d-flex flex-column">
                                    <div class="fw-semibold">
                                        Case #@Case.Id
                                        <span class="badge bg-secondary ms-2">@Case.TaskType</span>
                                    </div>
                                    <small class="text-muted">
                                        @(!string.IsNullOrWhiteSpace(Case.MetaInfo) ? Case.MetaInfo : "No metadata")
                                    </small>
                                </div>

                                <div class="text-end">
                                    <small class="text-muted">Assigned at</small><br />
                                    <small class="text-muted">@AssignedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</small>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="mb-2 text-muted small">
                                    Please read the original text and enter your judgment. Model output is hidden to avoid bias.
                                </div>
                                <pre class="border rounded p-3 mb-0 bg-body-tertiary" style="white-space: pre-wrap; word-break: break-word; max-height: 60vh; overflow:auto;">@((MarkupString)Case.RawText)</pre>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Annotation form -->
                    <div class="col-12 col-lg-4">
                        <div class="card shadow-sm">
                            <div class="card-header d-flex align-items-center justify-content-between">
                                <span class="fw-semibold">Your annotation</span>

                                <span class="d-inline-flex align-items-center gap-2 small">
                                    <span class="rounded-circle @( _leaseOk ? "bg-success" : "bg-danger")"
                                          style="width:10px;height:10px;display:inline-block;"></span>
                                    <span class="text-muted">@(_leaseOk ? "Lease OK" : "Lease expired")</span>
                                </span>
                            </div>

                            <div class="card-body">
                                <EditForm Model="@Form" OnValidSubmit="SubmitAsync" FormName="annotationForm">
                                    <DataAnnotationsValidator />
                                    <ValidationSummary />

                                    <!-- Task-specific input -->
                                    @if (Case.TaskType == TaskTypes.LVEF)
                                    {
                                        <div class="mb-3">
                                            <label class="form-label">LVEF (%)</label>
                                            <InputNumber @bind-Value="Form.LvefPercent"
                                                         class="form-control"
                                                         placeholder="e.g., 55" />
                                            <div class="form-text">对心脏超声的报告提取信息，寻找射血分数的值</div>
                                        </div>
                                    }
                                    else if (Case.TaskType == TaskTypes.IMT)
                                    {
                                        <div class="mb-3">
                                            <label class="form-label">IMT (mm)</label>
                                            <InputNumber @bind-Value="Form.ImtMm"
                                                         class="form-control"
                                                         step="0.01"
                                                         placeholder="e.g., 0.80" />
                                            <div class="form-text">对颈动脉超声的报告提取信息，寻找报告的颈动脉IMT，如果有多个值，回复最高IMT</div>
                                        </div>
                                    }
                                    else if (Case.TaskType == TaskTypes.STENOSIS)
                                    {
                                        <div class="mb-3">
                                            <label class="form-label">是否发生/发生过狭窄</label>
                                            <InputSelect @bind-Value="Form.Stenosis" class="form-select">
                                                <option value="">-- Select --</option>
                                                <option value="True">是</option>
                                                <option value="False">否</option>
                                            </InputSelect>
                                            <div class="form-text">对冠脉CTA报告的诊断结论进行分类，你只选择是/否，存在狭窄或斑块为是，无该问题为否，如果是支架术后，认为是发生过狭窄，其他类型的异常不需要关注</div>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="mb-3">
                                            <label class="form-label">Value</label>
                                            <InputText @bind-Value="Form.FreeTextValue"
                                                       class="form-control"
                                                       placeholder="Enter value..." />
                                            <div class="form-text">Unknown task type; free text enabled.</div>
                                        </div>
                                    }

                                    <!-- Special options -->
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <InputCheckbox @bind-Value="Form.CannotDetermine" class="form-check-input" id="cannotDetermine" />
                                            <label class="form-check-label" for="cannotDetermine">无法根据文本确定</label>
                                        </div>
                                        <div class="form-check">
                                            <InputCheckbox @bind-Value="Form.NoMentioned" class="form-check-input" id="noMentioned" />
                                            <label class="form-check-label" for="noMentioned">报告中未提及</label>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">备注</label>
                                        <InputTextArea @bind-Value="Form.Note"
                                                       class="form-control"
                                                       rows="3"
                                                       placeholder="Any ambiguity, where you found the value, etc." />
                                    </div>

                                    <!-- Optional research add-ons -->
                                    @* <div class="row g-2 mb-3">
                                        <div class="col-6">
                                            <label class="form-label">Confidence</label>
                                            <InputSelect @bind-Value="Form.Confidence"
                                                         class="form-select">
                                                <option value="">--</option>
                                                <option value="1">1 (low)</option>
                                                <option value="2">2</option>
                                                <option value="3">3</option>
                                                <option value="4">4</option>
                                                <option value="5">5 (high)</option>
                                            </InputSelect>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">Difficulty</label>
                                            <InputSelect @bind-Value="Form.Difficulty"
                                                         class="form-select">
                                                <option value="">--</option>
                                                <option value="1">1 (easy)</option>
                                                <option value="2">2</option>
                                                <option value="3">3</option>
                                                <option value="4">4</option>
                                                <option value="5">5 (hard)</option>
                                            </InputSelect>
                                        </div>
                                    </div> *@
                                    <div class="d-grid gap-2">
                                        <button type="submit" class="btn btn-primary" disabled="@IsSubmitting">
                                            @if (IsSubmitting)
                                            {
                                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                                <span>正在提交…</span>
                                            }
                                            else
                                            {
                                                <span>提交</span>
                                            }
                                        </button>

                                        <button type="button" class="btn btn-outline-secondary" @onclick="SkipAsync" disabled="@IsSubmitting">
                                            Skip (cannot read now)
                                        </button>
                                    </div>

                                    @if (!string.IsNullOrWhiteSpace(StatusMessage))
                                    {
                                        <div class="alert alert-info mt-3 mb-0" role="alert">
                                            @StatusMessage
                                        </div>
                                    }
                                </EditForm>
                            </div>

                            <div class="card-footer text-muted small d-flex justify-content-between">
                                <span>Rater: @CurrentRaterDisplay</span>
                                <span>Elapsed: @ElapsedText</span>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        }

    </Authorized>

    <NotAuthorized>
        <div class="alert alert-warning">
            Please sign in to annotate.
        </div>
        <a class="btn btn-primary" href="Account/Login">Go to Login</a>
    </NotAuthorized>
</AuthorizeView>



@code {
    // ---- Constants / enums ----
    private static class TaskTypes
    {
        public const string LVEF = "ExamEjectionFraction";
        public const string IMT = "ExamCarotidIMTPlaque";
        public const string STENOSIS = "ExamCoronaryCTA";
    }

    // ---- Page state ----
    private DateTime AssignedAt = DateTime.UtcNow;     // 不要 readonly，后续会更新
    private Guid AssignmentId;                         // 服务返回的 AssignmentId
    private int CurrentRound = 1;                      // R1/R2，仅用于显示/调试（可选）
    private bool IsSubmitting;
    private string? StatusMessage;

    private string CurrentRaterDisplay = "(unknown)";

    private PeriodicTimer? _uiTimer;
    private PeriodicTimer? _leaseTimer;
    private CancellationTokenSource? _uiCts;
    private CancellationTokenSource? _leaseCts;
    private bool _leaseOk = true;
    private DateTime _leaseExpiresAtLocal; // 可选：用于显示“租约到期时间”

    // Case 改成可空：加载前是 null
    private CaseVm? Case { get; set; }

    private AnnotationForm Form { get; set; } = new();

    private string ElapsedText => Case is null ? "-" : $"{Math.Max(0, (int)(DateTime.UtcNow - AssignedAt).TotalSeconds)}s";

    protected override async Task OnInitializedAsync()
    {
        _uiCts = new CancellationTokenSource();
        _uiTimer = new PeriodicTimer(TimeSpan.FromSeconds(1));
        _ = RunUiTimerAsync(_uiCts.Token);

        await LoadNextCaseAsync();     // 这里面拿到 AssignmentId 之后再启动 Lease
        StartLeaseLoop();
    }

    private async Task RunUiTimerAsync(CancellationToken token)
    {
        try
        {
            while (_uiTimer is not null && await _uiTimer.WaitForNextTickAsync(token))
            {
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (OperationCanceledException) { }
    }

    private void StartLeaseLoop()
    {
        StopLeaseLoop();

        // 没有 case 就不启
        if (Case is null || AssignmentId == Guid.Empty) return;

        _leaseOk = true;
        _leaseCts = new CancellationTokenSource();
        _leaseTimer = new PeriodicTimer(TimeSpan.FromSeconds(10)); // 10~15 秒一次即可

        _ = RunLeaseLoopAsync(_leaseCts.Token);
    }

    private void StopLeaseLoop()
    {
        try { _leaseCts?.Cancel(); } catch { }
        _leaseTimer?.Dispose();
        _leaseCts?.Dispose();
        _leaseTimer = null;
        _leaseCts = null;
    }

    private async Task RunLeaseLoopAsync(CancellationToken token)
    {
        try
        {
            while (_leaseTimer is not null && await _leaseTimer.WaitForNextTickAsync(token))
            {
                // 没有任务就不续
                if (Case is null || AssignmentId == Guid.Empty) continue;

                // 提交中也暂时别续，避免并发噪音（可选）
                if (IsSubmitting) continue;

                var loginName = await GetLoginNameAsync();

                bool ok = await AnnotationService.ExtendLeaseAsync(loginName, AssignmentId, token);

                if (!ok)
                {
                    _leaseOk = false;

                    await InvokeAsync(() =>
                    {
                        StatusMessage = "任务已过期或被回收，请重新获取任务。";
                        // 这里别直接 LoadNextCaseAsync()，避免循环里叠加 await
                    });

                    // 退出 loop，交给 UI/用户触发刷新，或你也可以自动 reload：
                    // await InvokeAsync(async () => await LoadNextCaseAsync());
                    // StartLeaseLoop();
                    break;
                }
                else
                {
                    _leaseOk = true;

                    // 可选：你如果在 AssignNextCaseResponse 里带了 ExpiresAtUtc，可以显示它
                    // _leaseExpiresAtLocal = res.ExpiresAtUtc.ToLocalTime();
                }
            }
        }
        catch (OperationCanceledException) { }
        catch (Exception ex)
        {
            _leaseOk = false;
            await InvokeAsync(() => StatusMessage = $"Lease heartbeat error: {ex.Message}");
        }
    }

    public async ValueTask DisposeAsync()
    {
        try { _uiCts?.Cancel(); } catch { }
        _uiTimer?.Dispose();
        _uiCts?.Dispose();

        StopLeaseLoop();

        await Task.CompletedTask;
    }

    private async Task LoadNextCaseAsync()
    {
        StatusMessage = null;

        var loginName = await GetLoginNameAsync();
        CurrentRaterDisplay = loginName;

        var res = await AnnotationService.AssignNextCaseAsync(loginName);

        if (res is null)
        {
            Case = null;
            StatusMessage = "No case available right now.";
            StopLeaseLoop();
            return;
        }

        AssignmentId = res.AssignmentId;
        CurrentRound = res.Round;
        AssignedAt = DateTime.UtcNow;
        StartLeaseLoop();
        Case = new CaseVm
        {
            Id = res.CaseId,
            TaskType = res.TaskType,
            MetaInfo = res.MetaInfo,
            RawText = res.RawText
        };

        Form = new();
        StateHasChanged();
    }

    // ---- Actions ----
    private async Task SubmitAsync()
    {
        if (Case is null) return;
        StopLeaseLoop();
        IsSubmitting = true;
        StatusMessage = null;

        try
        {
            var loginName = await GetLoginNameAsync();

            // 1) 把表单值转成一个最终的 AnnotatedValue
            var annotatedValue = BuildAnnotatedValue(Case.TaskType, Form);

            var req = new SubmitAnnotationRequest(
                AssignmentId: AssignmentId,
                CaseId: Case.Id,
                TaskType: Case.TaskType,
                AnnotatedValue: annotatedValue,
                Uncertainty: Form.Note, // 你也可以改成单独字段
                StartedAtUtc: AssignedAt,
                SubmittedAtUtc: DateTime.UtcNow,
                DifficultyScore: Form.Difficulty,
                ConfidenceScore: Form.Confidence
            );

            var resp = await AnnotationService.SubmitAsync(loginName, req);

            StatusMessage = resp.Message;

            // 2) 立即加载下一条
            await LoadNextCaseAsync();
        }
        finally
        {
            IsSubmitting = false;
        }
    }

    private async Task SkipAsync()
    {
        IsSubmitting = true;
        StatusMessage = null;

        try
        {
            // 如果你服务还没实现 Skip：先本地跳过，直接取下一条
            // 建议后面加一个 CaseAssignment.Status = Skipped
            StatusMessage = "Skipped. Loading next case…";
            await LoadNextCaseAsync();
        }
        finally
        {
            IsSubmitting = false;
        }
    }

    private static string BuildAnnotatedValue(string taskType, AnnotationForm form)
    {
        // 特殊选项优先
        if (form.CannotDetermine) return "CannotDetermine";
        if (form.NoMentioned) return "NotMentioned";

        if (string.Equals(taskType, TaskTypes.LVEF, StringComparison.OrdinalIgnoreCase))
            return form.LvefPercent?.ToString() ?? "";

        if (string.Equals(taskType, TaskTypes.IMT, StringComparison.OrdinalIgnoreCase))
            return form.ImtMm?.ToString() ?? "";

        if (string.Equals(taskType, TaskTypes.STENOSIS, StringComparison.OrdinalIgnoreCase))
            return form.Stenosis ?? "";

        return form.FreeTextValue ?? "";
    }

    private async Task<string> GetLoginNameAsync()
    {
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = state.User;

        // 1) 最常用：Identity.Name
        var name = user.Identity?.Name;

        // 2) 如果你需要 AD 的 sAMAccountName / preferred_username，可以从 claim 拿
        // var name = user.FindFirst("preferred_username")?.Value;

        return string.IsNullOrWhiteSpace(name) ? "anonymous" : name;
    }

    // ---- View models ----
    private sealed class CaseVm
    {
        public Guid Id { get; set; }                 // int -> Guid
        public string TaskType { get; set; } = "";
        public string? MetaInfo { get; set; }
        public string RawText { get; set; } = "";
    }

    private sealed class AnnotationForm
    {
        [Range(0, 100, ErrorMessage = "LVEF must be between 0 and 100.")]
        public int? LvefPercent { get; set; }

        [Range(0, 10, ErrorMessage = "IMT looks out of range (0–10mm).")]
        public decimal? ImtMm { get; set; }

        public string? Stenosis { get; set; }
        public string? FreeTextValue { get; set; }

        public bool CannotDetermine { get; set; }
        public bool NoMentioned { get; set; }

        [MaxLength(500)]
        public string? Note { get; set; }

        [Range(1, 5)]
        public int? Confidence { get; set; }

        [Range(1, 5)]
        public int? Difficulty { get; set; }
    }
}
